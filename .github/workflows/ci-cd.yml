name: CI/CD Pipeline with SonarQube

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master

jobs:
  sonarqube-analysis:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      
      - name: Build and analyze
        id: sonar-scan
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=alokpandey_agent_sdlc \
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.qualitygate.wait=true

      - name: Check Quality Gate
        id: quality-gate
        if: steps.sonar-scan.conclusion == 'failure'
        run: |
          echo "Quality gate failed - creating JIRA ticket"
          exit 1

      - name: Create JIRA ticket on failure
        if: always() && steps.sonar-scan.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const axios = require('axios');
            
            const jiraUrl = process.env.JIRA_URL;
            const jiraEmail = process.env.JIRA_EMAIL;
            const jiraToken = process.env.JIRA_API_TOKEN;
            const projectKey = process.env.JIRA_PROJECT_KEY;
            
            const auth = Buffer.from(`${jiraEmail}:${jiraToken}`).toString('base64');
            
            const issueData = {
              fields: {
                project: {
                  key: projectKey
                },
                summary: `SonarQube Quality Gate Failed - ${context.repo.repo} - ${context.sha.substring(0, 7)}`,
                description: {
                  type: "doc",
                  version: 1,
                  content: [
                    {
                      type: "paragraph",
                      content: [
                        {
                          type: "text",
                          text: `SonarQube quality gate failed for commit ${context.sha}`
                        }
                      ]
                    },
                    {
                      type: "paragraph",
                      content: [
                        {
                          type: "text",
                          text: `Repository: ${context.repo.owner}/${context.repo.repo}`
                        }
                      ]
                    },
                    {
                      type: "paragraph",
                      content: [
                        {
                          type: "text",
                          text: `Branch: ${context.ref}`
                        }
                      ]
                    },
                    {
                      type: "paragraph",
                      content: [
                        {
                          type: "text",
                          text: `Commit: ${context.sha}`
                        }
                      ]
                    },
                    {
                      type: "paragraph",
                      content: [
                        {
                          type: "text",
                          text: `Action: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
                        }
                      ]
                    }
                  ]
                },
                issuetype: {
                  name: "Bug"
                },
                labels: ["sonarqube", "quality-gate-failure", "auto-generated"]
              }
            };
            
            try {
              const response = await axios.post(
                `${jiraUrl}/rest/api/3/issue`,
                issueData,
                {
                  headers: {
                    'Authorization': `Basic ${auth}`,
                    'Content-Type': 'application/json'
                  }
                }
              );
              
              console.log(`JIRA ticket created: ${response.data.key}`);
              core.setOutput('jira-ticket', response.data.key);
            } catch (error) {
              console.error('Failed to create JIRA ticket:', error.response?.data || error.message);
            }
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}


name: CI/CD Pipeline with SonarQube

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master

jobs:
  sonarqube-analysis:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      
      - name: Build and analyze
        id: sonar-scan
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          set +e
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=alokpandey_agent_sdlc \
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.qualitygate.wait=true
          SONAR_EXIT_CODE=$?
          echo "sonar_exit_code=$SONAR_EXIT_CODE" >> $GITHUB_OUTPUT

          # Extract task ID from Maven output
          TASK_ID=$(grep -oP 'ceTaskId=\K[^,}]+' target/sonar/report-task.txt | head -1)
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT

          if [ $SONAR_EXIT_CODE -ne 0 ]; then
            echo "SonarQube quality gate failed with exit code $SONAR_EXIT_CODE"
            exit 1
          fi

      - name: Fetch SonarQube Quality Gate Details
        id: sonar-details
        if: always() && steps.sonar-scan.outputs.sonar_exit_code != '0'
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # Fetch quality gate status from SonarCloud API
          RESPONSE=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=alokpandey_agent_sdlc")

          echo "Quality Gate Response: $RESPONSE"

          # Extract status and conditions
          STATUS=$(echo "$RESPONSE" | jq -r '.projectStatus.status // "UNKNOWN"')
          echo "quality_gate_status=$STATUS" >> $GITHUB_OUTPUT

          # Fetch detailed issues - Bugs
          BUGS_RESPONSE=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=alokpandey_agent_sdlc&resolved=false&types=BUG&ps=50")

          BUGS_COUNT=$(echo "$BUGS_RESPONSE" | jq -r '.total // 0')
          echo "bugs=$BUGS_COUNT" >> $GITHUB_OUTPUT

          # Extract bug details and save to output (base64 encoded to handle special characters)
          BUGS_DETAILS=$(echo "$BUGS_RESPONSE" | jq -r '.issues[] | "[\(.severity)] \(.message) - \(.component | split(":") | last) (Line \(.line // "N/A"))"' | head -50 | base64 -w 0)
          echo "bugs_details=$BUGS_DETAILS" >> $GITHUB_OUTPUT

          # Fetch detailed issues - Vulnerabilities
          VULNS_RESPONSE=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=alokpandey_agent_sdlc&resolved=false&types=VULNERABILITY&ps=50")

          VULNS_COUNT=$(echo "$VULNS_RESPONSE" | jq -r '.total // 0')
          echo "vulnerabilities=$VULNS_COUNT" >> $GITHUB_OUTPUT

          # Extract vulnerability details and save to output (base64 encoded)
          VULNS_DETAILS=$(echo "$VULNS_RESPONSE" | jq -r '.issues[] | "[\(.severity)] \(.message) - \(.component | split(":") | last) (Line \(.line // "N/A"))"' | head -50 | base64 -w 0)
          echo "vulns_details=$VULNS_DETAILS" >> $GITHUB_OUTPUT

          # Fetch detailed issues - Code Smells (limit to top 20)
          CODE_SMELLS_RESPONSE=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=alokpandey_agent_sdlc&resolved=false&types=CODE_SMELL&ps=20")

          CODE_SMELLS_COUNT=$(echo "$CODE_SMELLS_RESPONSE" | jq -r '.total // 0')
          echo "code_smells=$CODE_SMELLS_COUNT" >> $GITHUB_OUTPUT

          # Extract code smell details (top 20) and save to output (base64 encoded)
          CODE_SMELLS_DETAILS=$(echo "$CODE_SMELLS_RESPONSE" | jq -r '.issues[] | "[\(.severity)] \(.message) - \(.component | split(":") | last) (Line \(.line // "N/A"))"' | head -20 | base64 -w 0)
          echo "code_smells_details=$CODE_SMELLS_DETAILS" >> $GITHUB_OUTPUT

          # Fetch Security Hotspots
          HOTSPOTS_RESPONSE=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/hotspots/search?projectKey=alokpandey_agent_sdlc&ps=50")

          HOTSPOTS_COUNT=$(echo "$HOTSPOTS_RESPONSE" | jq -r '.paging.total // 0')
          echo "security_hotspots=$HOTSPOTS_COUNT" >> $GITHUB_OUTPUT

          # Extract security hotspot details and save to output (base64 encoded)
          HOTSPOTS_DETAILS=$(echo "$HOTSPOTS_RESPONSE" | jq -r '.hotspots[]? | "[\(.vulnerabilityProbability)] \(.message) - \(.component | split(":") | last) (Line \(.line // "N/A"))"' | head -50 | base64 -w 0)
          echo "hotspots_details=$HOTSPOTS_DETAILS" >> $GITHUB_OUTPUT

      - name: Check Quality Gate
        id: quality-gate
        if: steps.sonar-scan.outputs.sonar_exit_code != '0'
        run: |
          echo "Quality gate failed - creating JIRA ticket"
          exit 1

      - name: Create JIRA ticket on failure
        if: always() && steps.sonar-scan.outputs.sonar_exit_code != '0'
        uses: actions/github-script@v7
        with:
          script-file: .github/scripts/create-jira-ticket.js
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          QG_STATUS: ${{ steps.sonar-details.outputs.quality_gate_status }}
          BUGS: ${{ steps.sonar-details.outputs.bugs }}
          VULNERABILITIES: ${{ steps.sonar-details.outputs.vulnerabilities }}
          CODE_SMELLS: ${{ steps.sonar-details.outputs.code_smells }}
          SECURITY_HOTSPOTS: ${{ steps.sonar-details.outputs.security_hotspots }}
          BUGS_DETAILS: ${{ steps.sonar-details.outputs.bugs_details }}
          VULNS_DETAILS: ${{ steps.sonar-details.outputs.vulns_details }}
          CODE_SMELLS_DETAILS: ${{ steps.sonar-details.outputs.code_smells_details }}
          HOTSPOTS_DETAILS: ${{ steps.sonar-details.outputs.hotspots_details }}

